name: Build APKs
run-name: Build APKs
on:
  workflow_dispatch: {}
jobs:
  upload-release:
    if: ${{ !contains(github.ref, '+') }}
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download
        uses: actions/download-artifact@v4
        with:
          run-id: 11064495916
          path: ./dist/
          pattern: artifact-*
          merge-multiple: true

      - name: Pre Release
        run: |
          sudo apt install jq
          curl -s https://api.github.com/repos/wgh136/PicaComic/releases/latest | jq -r '.body' > release.md
          r_tag_name=$(curl -s https://api.github.com/repos/wgh136/PicaComic/releases/latest | jq -r '.tag_name')
          echo $r_tag_name

      - name: Rename
        run: |
          cd ./dist
          version=${r_tag_name:1}
          echo $version
          for file in *.apk; do
              if [[ $file =~ ^app-(.*)-release\.apk$ ]]; then
                  new_name="PicaComic-$version-${BASH_REMATCH[1]}.apk"
                  mv "$file" "$new_name"
              fi
          done
          mv app-release.apk "PicaComic-$version-universal.apk"
          cd ..
